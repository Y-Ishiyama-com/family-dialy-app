name: System Integration Tests

on:
  workflow_dispatch:  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã®ã¿
  schedule:
    - cron: '0 10 * * *'  # æ¯Žæ—¥10:00 UTC ã«å®Ÿè¡Œ

env:
  AWS_REGION: us-west-2

jobs:
  test-prompt-generation:
    name: Test Prompt Generation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check DynamoDB prompts table
        run: |
          echo "Checking diary_prompts table..."
          TABLE_STATUS=$(aws dynamodb describe-table \
            --table-name diary_prompts \
            --query 'Table.TableStatus' \
            --output text 2>/dev/null || echo "NOT_FOUND")
          
          if [ "$TABLE_STATUS" == "ACTIVE" ]; then
            echo "âœ“ diary_prompts table is ACTIVE"
          else
            echo "âš ï¸ diary_prompts table status: $TABLE_STATUS"
          fi

      - name: Check Lambda function existence
        run: |
          echo "Checking family-diary-prompt-generator Lambda..."
          FUNCTION_ARN=$(aws lambda get-function \
            --function-name family-diary-prompt-generator \
            --query 'Configuration.FunctionArn' \
            --output text 2>/dev/null || echo "NOT_FOUND")
          
          if [ "$FUNCTION_ARN" != "NOT_FOUND" ]; then
            echo "âœ“ Lambda function exists: $FUNCTION_ARN"
          else
            echo "âš ï¸ Lambda function not found"
            exit 1
          fi

      - name: Invoke prompt generator Lambda
        id: lambda_invoke
        run: |
          echo "Invoking prompt generator Lambda..."
          RESPONSE=$(aws lambda invoke \
            --function-name family-diary-prompt-generator \
            --payload '{}' \
            --region ${{ env.AWS_REGION }} \
            /tmp/lambda-response.json \
            && cat /tmp/lambda-response.json)
          
          echo "Lambda response: $RESPONSE"
          
          # Check if response contains success status
          if echo "$RESPONSE" | grep -q '"statusCode": 200'; then
            echo "âœ“ Lambda execution successful"
            echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Lambda execution failed or returned error"
            echo "$RESPONSE"
          fi

      - name: Verify prompt in DynamoDB
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          echo "Checking for prompt on $TODAY..."
          
          PROMPT_ITEM=$(aws dynamodb get-item \
            --table-name diary_prompts \
            --key "{\"date\": {\"S\": \"$TODAY\"}}" \
            --output json 2>/dev/null || echo '{}')
          
          if echo "$PROMPT_ITEM" | grep -q '"prompt"'; then
            PROMPT=$(echo "$PROMPT_ITEM" | jq -r '.Item.prompt.S')
            CATEGORY=$(echo "$PROMPT_ITEM" | jq -r '.Item.category.S')
            echo "âœ“ Prompt found for $TODAY"
            echo "  Prompt: $PROMPT"
            echo "  Category: $CATEGORY"
          else
            echo "âš ï¸ No prompt found for $TODAY yet (may not have run yet)"
          fi

  test-api-endpoint:
    name: Test API Endpoint
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Check API endpoint
        run: |
          API_ENDPOINT="${{ secrets.VITE_API_ENDPOINT }}"
          
          if [ -z "$API_ENDPOINT" ]; then
            echo "âš ï¸ VITE_API_ENDPOINT secret not set"
            exit 1
          fi
          
          echo "Testing API endpoint: $API_ENDPOINT"
          
          # Test health check (no auth required)
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$API_ENDPOINT/health")
          
          if [ "$HEALTH_RESPONSE" == "200" ]; then
            echo "âœ“ API health check passed"
          else
            echo "âš ï¸ API health check returned: $HEALTH_RESPONSE"
          fi

  test-eventbridge-rule:
    name: Test EventBridge Rule
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check EventBridge rule
        run: |
          echo "Checking DailyPromptGenerationRule..."
          
          RULE_STATE=$(aws events describe-rule \
            --name DailyPromptGenerationRule \
            --query 'State' \
            --output text 2>/dev/null || echo "NOT_FOUND")
          
          if [ "$RULE_STATE" == "ENABLED" ]; then
            echo "âœ“ EventBridge rule is ENABLED"
            
            # Get rule schedule
            SCHEDULE=$(aws events describe-rule \
              --name DailyPromptGenerationRule \
              --query 'ScheduleExpression' \
              --output text)
            echo "  Schedule: $SCHEDULE"
          elif [ "$RULE_STATE" == "NOT_FOUND" ]; then
            echo "âš ï¸ EventBridge rule not found"
            exit 1
          else
            echo "âš ï¸ EventBridge rule state: $RULE_STATE"
          fi

      - name: Check EventBridge targets
        run: |
          echo "Checking EventBridge targets..."
          
          TARGETS=$(aws events list-targets-by-rule \
            --rule DailyPromptGenerationRule \
            --output json 2>/dev/null || echo '{"Targets":[]}')
          
          TARGET_COUNT=$(echo "$TARGETS" | jq '.Targets | length')
          
          if [ "$TARGET_COUNT" -gt 0 ]; then
            echo "âœ“ Found $TARGET_COUNT target(s)"
            echo "$TARGETS" | jq -r '.Targets[] | "  - \(.Arn)"'
          else
            echo "âš ï¸ No targets configured for EventBridge rule"
          fi

  integration-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [test-prompt-generation, test-api-endpoint, test-eventbridge-rule]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "### ðŸ”— Integration Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**System Components Tested:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ DynamoDB (diary_prompts table)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Lambda (prompt generator)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ API Gateway (health check)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ EventBridge (schedule rule)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
